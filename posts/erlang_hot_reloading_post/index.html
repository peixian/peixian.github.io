<!DOCTYPE html>
<html><head>
<title>erlang hot reloading post</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://rsms.me" crossorigin>


<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400;1,700&family=JetBrains+Mono&display=swap">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">



<link rel="stylesheet" href="/css/main.min.7a8dc5b063775e5d3df0beea151395736f55ccb3343f70eea0595b53da5015c4.css">


<script defer src="/en.search.min.50e9343cf7b777f57f33fb11d2c41f08fc9689e37f80b207dab7303d464623e3.js" integrity="sha256-UOk0PPe3d/V/M/sR0sQfCPyWieN/gLIH2rcwPUZGI&#43;M="></script>


<link rel="stylesheet" href="/katex/katex.min.css" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="/katex/katex.min.css"></noscript>
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
</head>
<body><header>
    <div class="header-main">
        <a href="/" id="logo">
            <img src="/svg/icon.svg" alt="icon" id="raccoon" />
        </a>
        <h3 class="site-title">عجفت الغور</h3>
        <div id="search">
            
<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>

        </div>
    </div>
    <nav id="breadcrumb" aria-label="Note trail"><span class="trail-label">trail</span><span class="trail-crumbs"></span></nav>
</header>

<div class="layout-container">
  <div class="grid-container">
    <div class="grid">
      <div class="page" data-level="1">
        <div class="content">
            <h1>erlang hot reloading post</h1>
            


            <p><a href="/posts/drafts/">drafts</a>, <a href="/posts/erlang/">erlang</a></p>
<p>Hot reloading in the BEAM VM</p>
<ul>
<li>Counter v1</li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>-module(counter).
</span></span><span style="display:flex;"><span>-behaviour(gen_server).
</span></span><span style="display:flex;"><span>-vsn(<span style="color:#e6db74">&#34;1.0.0&#34;</span>).
</span></span><span style="display:flex;"><span>-export([start_link<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>, get_count<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>, increment<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>]).
</span></span><span style="display:flex;"><span>-export([init<span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>, handle_call<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span>, handle_cast<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>, code_change<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span>, terminate<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>, handle_info<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>]).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">%% -- API --
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">start_link</span>() <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    gen_server:<span style="color:#a6e22e">start_link</span>({local, <span style="color:#f92672">?</span>MODULE}, <span style="color:#f92672">?</span>MODULE, [], []).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">get_count</span>() <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    gen_server:<span style="color:#a6e22e">call</span>(<span style="color:#f92672">?</span>MODULE, get_count).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">increment</span>() <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    gen_server:<span style="color:#a6e22e">cast</span>(<span style="color:#f92672">?</span>MODULE, increment).
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">%% -- Callbacks --
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">init</span>([]) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    {ok, <span style="color:#ae81ff">0</span>}.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">handle_cast</span>(increment, Count) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    {noreply, Count <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>}.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">handle_call</span>(get_count, _From, Count) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    {reply, Count, Count}.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">code_change</span>(_OldVsn, State, _Extra) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    {ok, State}.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">handle_info</span>(_Info, State) <span style="color:#f92672">-&gt;</span> {noreply, State}.
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">terminate</span>(_Reason, _State) <span style="color:#f92672">-&gt;</span> ok.
</span></span></code></pre></div><ul>
<li>Counter v2</li>
</ul>
<blockquote>
<p>-module(counter).
-behaviour(gen_server).
-vsn(&ldquo;2.0.0&rdquo;).
-export([start_link/0, get_count/0, increment/0, get_info/0]).
-export([init/1, handle_call/3, handle_cast/2, code_change/3, terminate/2, handle_info/2]).</p>
<p>%% State map
-record(state, {
count = 0,
increment_count = 0,
last_updated
}).</p>
<p>%% &ndash; API &ndash;
start_link() -&gt;
gen_server:start_link({local, ?MODULE}, ?MODULE, [], []).</p>
<p>get_count() -&gt;
gen_server:call(?MODULE, get_count).</p>
<p>increment() -&gt;
gen_server:cast(?MODULE, increment).</p>
<p>get_info() -&gt;
sys:get_state(?MODULE).</p>
<p>%% &ndash; Callbacks &ndash;</p>
<p>init([]) -&gt;
{ok, #state{}}.</p>
<p>handle_cast(increment, State) -&gt;
{noreply, State#state{count = State#state.count + 1,
increment_count = 1,
last_updated = erlang:timestamp()
}}.</p>
<p>handle_call(get_count, _From, State) -&gt;
{reply, State#state.count, State}.</p>
<p>code_change(&ldquo;1.0.0&rdquo;, OldState, _Extra) when is_integer(OldState) -&gt;
NewState = #state{
count = OldState,
increment_count = OldState,
last_updated = erlang:timestamp()},
{ok, NewState};</p>
<p>code_change(_OldVsn, State, _Extra) -&gt;
{ok, State}.</p>
<p>handle_info(_Info, State) -&gt; {noreply, State}.
terminate(_Reason, _State) -&gt; ok.</p>
</blockquote>
<ul>
<li>Running</li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>peixian@Mac <span style="color:#960050;background-color:#1e0010">~</span><span style="color:#f92672">/</span>c<span style="color:#f92672">/</span>erl<span style="color:#f92672">-</span>hot<span style="color:#f92672">-</span>reloading<span style="color:#f92672">&gt;</span> erl
</span></span><span style="display:flex;"><span>Erlang<span style="color:#f92672">/</span>OTP <span style="color:#ae81ff">27</span> [erts<span style="color:#f92672">-</span><span style="color:#ae81ff">15</span>.<span style="color:#ae81ff">2</span>] [source] [<span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>bit] [smp:<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">8</span>] [ds:<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">10</span>] [async<span style="color:#f92672">-</span>threads:<span style="color:#ae81ff">1</span>] [jit]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Eshell V15.<span style="color:#ae81ff">2</span> (press Ctrl<span style="color:#f92672">+</span>G to abort, type help(). for help)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span> file:<span style="color:#a6e22e">copy</span>(<span style="color:#e6db74">&#34;counter_v1.erl&#34;</span>, <span style="color:#e6db74">&#34;counter.erl&#34;</span>), c(counter).
</span></span><span style="display:flex;"><span>{ok,counter}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span> counter:<span style="color:#a6e22e">start_link</span>().
</span></span><span style="display:flex;"><span>{ok,<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">95</span>.<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#f92672">&gt;</span> counter:<span style="color:#a6e22e">increment</span>().
</span></span><span style="display:flex;"><span>ok
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;</span> counter:<span style="color:#a6e22e">increment</span>().
</span></span><span style="display:flex;"><span>ok
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;</span> counter:<span style="color:#a6e22e">get_count</span>().
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span><span style="color:#f92672">&gt;</span> file:<span style="color:#a6e22e">copy</span>(<span style="color:#e6db74">&#34;counter_v2.erl&#34;</span>, <span style="color:#e6db74">&#34;counter.erl&#34;</span>), c(counter).
</span></span><span style="display:flex;"><span>{ok,counter}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span><span style="color:#f92672">&gt;</span> counter:<span style="color:#a6e22e">get_info</span>().
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> sys:<span style="color:#a6e22e">change_code</span>(counter, counter, <span style="color:#e6db74">&#34;1.0.0&#34;</span>, []).
</span></span><span style="display:flex;"><span>{error,{unknown_system_msg,{change_code,counter,<span style="color:#e6db74">&#34;1.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>                                        []}}}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> sys:<span style="color:#a6e22e">suspend</span>(counter).
</span></span><span style="display:flex;"><span>ok
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span><span style="color:#f92672">&gt;</span> sys:<span style="color:#a6e22e">change_code</span>(counter, counter, <span style="color:#e6db74">&#34;1.0.0&#34;</span>, []).
</span></span><span style="display:flex;"><span>ok
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span><span style="color:#f92672">&gt;</span> sys:<span style="color:#a6e22e">resume</span>(counter).
</span></span><span style="display:flex;"><span>ok
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12</span><span style="color:#f92672">&gt;</span> counter:<span style="color:#a6e22e">get_info</span>().
</span></span><span style="display:flex;"><span>{state,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>,{<span style="color:#ae81ff">1769</span>,<span style="color:#ae81ff">908677</span>,<span style="color:#ae81ff">996152</span>}}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><ul>
<li>Basically
<ol>
<li>Code server keeps two versions</li>
<li>Local calls within an old version of the genserver route to the old version (via VSN)</li>
<li>New calls route in the newer version</li>
<li>Need to be very careful about suspending a process</li>
<li>But you can also track processes, and loop over them to reload one by one</li>
<li><code>code_change</code> itself takes callbacks, so you can write arbitrary migration code</li>
<li>You can do this without even removing dependencies, such as TCP socket open</li>
<li>TCP socket demo
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"></code></pre></div></li>
</ol>
</li>
</ul>

            




   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   




        </div>
      </div>
    </div>
  </div>
  


</div>

<script src="/js/URI.js" type="text/javascript"></script>

<script src="/js/page.js" type="text/javascript"></script>
</body>
</html>
