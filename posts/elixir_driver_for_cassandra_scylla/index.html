<!DOCTYPE html>
<html><title>elixir driver for cassandra/scylla</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes" />


<link rel="stylesheet" href="/css/main.min.532078bb650bec3433e8e9db19e0453faa66c9cc0ce761054558a91d87039e9d.css"/>
<script defer src="/en.search.min.de5b06b8053abaef4877a76a5ab7354b95564491c15ca2fa12ad6cec7021035f.js" integrity="sha256-3lsGuAU6uu9Id6dqWrc1S5VWRJHBXKL6Eq1s7HAhA18="></script>

<link rel="stylesheet" href="/katex/katex.min.css" />
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
<body><header>
    <a href="/" id="logo">
        <img src="/svg/icon.svg" alt="icon" id="raccoon" />

    </a>
    <h3 class="site-title">عجفت الغور</h3>
    <div id="search">
        
<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>

    </div>
</header>

<div class="grid-container">
  <div class="grid">
    <div class="page" data-level="1">
      <div class="content">
          <h1>elixir driver for cassandra/scylla</h1>

          <p><a href="/posts/elixir/">elixir</a>, <a href="/posts/20200415152613-cassandra/">Cassandra</a></p>
<ul>
<li>Use a nif to gate <a href="https://cpp-driver.docs.scylladb.com/master/">https://cpp-driver.docs.scylladb.com/master/</a></li>
<li><a href="https://github.com/bencheeorg/benchee_json">https://github.com/bencheeorg/benchee_json</a> &lt;- benchmarking runtimes</li>
<li><a href="https://github.com/vinoski/bitwise">https://github.com/vinoski/bitwise</a> &lt;- <a href="/posts/erlang/#nif-issues">Nif Issues</a></li>
<li>similar wrapper but for leveldb &lt;- <a href="https://github.com/basho/eleveldb">https://github.com/basho/eleveldb</a></li>
</ul>
<h2 id="tokenaware-lb-policy-for-xandra-and-shard-awareness">TokenAware LB Policy for Xandra and Shard Awareness</h2>
<ul>
<li><a href="https://university.scylladb.com/courses/using-scylla-drivers/lessons/scylla-specific-drivers-overview-paging-and-shard-awareness/">https://university.scylladb.com/courses/using-scylla-drivers/lessons/scylla-specific-drivers-overview-paging-and-shard-awareness/</a></li>
<li><a href="https://www.scylladb.com/2021/04/27/connect-faster-to-scylla-with-a-shard-aware-port/">https://www.scylladb.com/2021/04/27/connect-faster-to-scylla-with-a-shard-aware-port/</a></li>
<li><a href="https://www.scylladb.com/glossary/cassandra-query-language-cql/">https://www.scylladb.com/glossary/cassandra-query-language-cql/</a></li>
<li><a href="https://monitoring.docs.scylladb.com/stable/use-monitoring/advisor/cqlNoTokenAware.html">https://monitoring.docs.scylladb.com/stable/use-monitoring/advisor/cqlNoTokenAware.html</a></li>
</ul>
<h3 id="python-examples">Python Examples</h3>
<ul>
<li><a href="https://github.com/scylladb/python-driver/blob/64e7fad42ec88dfc72c7f12c389c3ef6c3f392fb/cassandra/pool.py#L659">https://github.com/scylladb/python-driver/blob/64e7fad42ec88dfc72c7f12c389c3ef6c3f392fb/cassandra/pool.py#L659</a></li>
<li><a href="https://github.com/scylladb/scylladb/blob/master/docs/dev/protocol-extensions.md#intranode-sharding">https://github.com/scylladb/scylladb/blob/master/docs/dev/protocol-extensions.md#intranode-sharding</a></li>
<li><a href="https://github.com/search?q=repo%3Ascylladb%2Fpython-driver%20shard_aware_port&amp;type=code">https://github.com/search?q=repo%3Ascylladb%2Fpython-driver%20shard_aware_port&amp;type=code</a></li>
<li><a href="https://python-driver.docs.scylladb.com/stable/">https://python-driver.docs.scylladb.com/stable/</a></li>
</ul>
<h3 id="java-reference">Java Reference</h3>
<ul>
<li><a href="https://docs.datastax.com/en/drivers/java/2.1/com/datastax/driver/core/policies/TokenAwarePolicy.html">https://docs.datastax.com/en/drivers/java/2.1/com/datastax/driver/core/policies/TokenAwarePolicy.html</a></li>
<li><a href="https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/MurmurHash.java#L28-L29git">https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/MurmurHash.java#L28-L29git</a></li>
</ul>
<h3 id="elixir-nif">Elixir NIF</h3>
<ul>
<li>
<p><a href="https://github.com/lpgauth/murmur">https://github.com/lpgauth/murmur</a></p>
</li>
<li>
<p>Possibly something like this? -</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span><span style="color:#66d9ef">defmodule</span> <span style="color:#a6e22e">ShardCalculator</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@min_token</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@token_max</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> calculate_shard(token, ignore_msb, nr_shards) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Bias the token</span>
</span></span><span style="display:flex;"><span>    biased_token <span style="color:#f92672">=</span> token <span style="color:#f92672">-</span> <span style="color:#a6e22e">@min_token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Left shift by ignore_msb bits</span>
</span></span><span style="display:flex;"><span>    biased_token <span style="color:#f92672">=</span> biased_token <span style="color:#f92672">&lt;&lt;&lt;</span> ignore_msb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Multiply by number of shards and perform truncating division</span>
</span></span><span style="display:flex;"><span>    shard <span style="color:#f92672">=</span> div(biased_token <span style="color:#f92672">*</span> nr_shards, <span style="color:#a6e22e">@token_max</span>)
</span></span><span style="display:flex;"><span>    shard
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elixir" data-lang="elixir"><span style="display:flex;"><span><span style="color:#66d9ef">defmodule</span> <span style="color:#a6e22e">ShardCalculator</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@min_token</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@token_max</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> calculate_shard(token, ignore_msb, nr_shards) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    token <span style="color:#f92672">=</span> token <span style="color:#f92672">-</span> <span style="color:#a6e22e">@min_token</span>
</span></span><span style="display:flex;"><span>    token <span style="color:#f92672">=</span> token <span style="color:#f92672">&lt;&lt;&lt;</span> ignore_msb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tok_lo <span style="color:#f92672">=</span> token <span style="color:#f92672">&amp;&amp;&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF</span>
</span></span><span style="display:flex;"><span>    tok_hi <span style="color:#f92672">=</span> token <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mul1 <span style="color:#f92672">=</span> tok_lo <span style="color:#f92672">*</span> nr_shards
</span></span><span style="display:flex;"><span>    mul2 <span style="color:#f92672">=</span> tok_hi <span style="color:#f92672">*</span> nr_shards
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sum <span style="color:#f92672">=</span> (mul1 <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#ae81ff">32</span>) <span style="color:#f92672">+</span> mul2
</span></span><span style="display:flex;"><span>    sum <span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="existing-xandra">Existing Xandra</h3>
<ul>
<li><a href="https://github.com/whatyouhide/xandra/blob/a21d162db7b1b131a3df27764bf559ec56d66823/lib/xandra/cluster/load_balancing_policy/dc_aware_round_robin.ex">https://github.com/whatyouhide/xandra/blob/a21d162db7b1b131a3df27764bf559ec56d66823/lib/xandra/cluster/load_balancing_policy/dc_aware_round_robin.ex</a></li>
</ul>
<h3 id="worklist">Worklist</h3>
<ul>
<li>Wrap around the idea of distance: <a href="https://docs.datastax.com/en/developer/java-driver/3.6/manual/load_balancing/">https://docs.datastax.com/en/developer/java-driver/3.6/manual/load_balancing/</a>
<ul>
<li><a href="https://docs.datastax.com/en/cassandra-oss/3.0/cassandra/architecture/archDataDistributeHashing.html">https://docs.datastax.com/en/cassandra-oss/3.0/cassandra/architecture/archDataDistributeHashing.html</a></li>
</ul>
</li>
<li>Look into fallback strats: <a href="https://docs.datastax.com/en/developer/java-driver/3.6/manual/load_balancing/#fallback-strategies">https://docs.datastax.com/en/developer/java-driver/3.6/manual/load_balancing/#fallback-strategies</a></li>
</ul>

          




   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   




      </div>
    </div>
  </div>
</div>

<script src="/js/URI.js" type="text/javascript"></script>

<script src="/js/page.js" type="text/javascript"></script>
</body>
</html>
