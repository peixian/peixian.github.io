<!DOCTYPE html>
<html><title>programming kubernetes chapter 3 - client-go</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes" />


<link rel="stylesheet" href="/css/main.min.7e9d163bca6e3791417a0e81190cd6067c7d0412819ec9e96db3dc3f5e88ce8c.css"/>
<script defer src="/en.search.min.1f4608c6b0d223d528948268456f7410ddf252788e6f0b2ae85d75cc09f93192.js" integrity="sha256-H0YIxrDSI9UolIJoRW90EN3yUniObwsq6F11zAn5MZI="></script>

<link rel="stylesheet" href="/katex/katex.min.css" />
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
<body><header>
    <a href="/" id="logo">
        <img src="/svg/icon.svg" alt="icon" id="raccoon" />

    </a>
    <h3 class="site-title">عجفت الغور</h3>
    <div id="search">
        
<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>

    </div>
</header>

<div class="grid-container">
  <div class="grid">
    <div class="page" data-level="1">
      <div class="content">
          <h1>programming kubernetes chapter 3 - client-go</h1>

          <p>Tags: <a href="/posts/programming_kubernetes/">hausenblas - programming kubernetes</a></p>
<ul>
<li>
<p>Overview: controllers can be constructed by calling the client-go library, which provides a set of sensible defaults such as work queues and informers</p>
</li>
<li>
<p><a href="https://github.com/kubernetes/client-go">https://github.com/kubernetes/client-go</a></p>
<ul>
<li>most api types can be found under <a href="https://github.com/kubernetes/client-go/tree/master/listers">https://github.com/kubernetes/client-go/tree/master/listers</a></li>
</ul>
</li>
<li>
<p>api definitions: <a href="https://github.com/kubernetes/api">https://github.com/kubernetes/api</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/apimachinery">https://github.com/kubernetes/apimachinery</a> - generic building blocks to kube-like API, not restricted to container management</p>
<ul>
<li>most of the generic API types (<code>ObjectMeta</code>, <code>TypeMeta</code>, <code>GetOptions</code>, <code>ListOptions</code>) are in <a href="https://github.com/kubernetes/apimachinery/tree/master/pkg/apis/meta/v1">https://github.com/kubernetes/apimachinery/tree/master/pkg/apis/meta/v1</a></li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// basic client
</span><span style="color:#75715e"></span>
<span style="color:#f92672">import</span> (
    <span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
    <span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
    <span style="color:#e6db74">&#34;k8s.io/client-go/kubernetes&#34;</span>
)

<span style="color:#a6e22e">kubeconfig</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;kubeconfig, &#34;</span><span style="color:#960050;background-color:#1e0010">~</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">kube</span><span style="color:#f92672">/</span><span style="color:#a6e22e">config</span><span style="color:#e6db74">&#34;, &#34;</span><span style="color:#a6e22e">kubeconfig</span> <span style="color:#a6e22e">file</span><span style="color:#e6db74">&#34;)
</span><span style="color:#e6db74">flag.Parse()
</span><span style="color:#e6db74">config, err := clientcmd.BuildConfigFromFlags(&#34;&#34;, *kubeconfig)
</span><span style="color:#e6db74">clientset, err := kubernetes.NewForConfig(config)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">pod, err := clientset.CoreV1().Pods(&#34;</span><span style="color:#a6e22e">book</span><span style="color:#e6db74">&#34;).Get(&#34;</span><span style="color:#a6e22e">example</span><span style="color:#960050;background-color:#1e0010">&#34;</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetOptions</span>{})
</code></pre></div><p>This parses the appropriate kubeconfig and then gets the pods using the <code>GetOptions</code></p>
<p>If you run a binary inside of a pod inside a cluster, <code>kubelet</code> automatically mounts a sservice account into <code>/var/run/secrets/kubernetes.io/serviceaccount</code></p>
<p>CRUD operations are run through the <code>XOptions</code>, such as <code>CreateOptions</code> or <code>DeleteOptions</code>. ALl of htem are part of <code>ObjectMeta</code></p>
<ul>
<li>
<p>alpha/beta/vN verisons are what you would expect (alpha changes, beta is unlikely to break, vN is stable)</p>
</li>
<li>
<p>each object stored in etcd is stored as a specific version known as the <em>storage version</em> of that resource</p>
</li>
<li>
<p>anything served as a kind is a struct</p>
<ul>
<li>all objects can be retrived and deepcopied</li>
<li>each object stores its groupversionkind</li>
</ul>
</li>
</ul>
<h2 id="type-meta">type meta</h2>
<ul>
<li><a href="https://github.com/kubernetes/apimachinery/blob/10b38829b6211c0d672e14a126479221312d3368/pkg/apis/meta/v1/types.go#L41">https://github.com/kubernetes/apimachinery/blob/10b38829b6211c0d672e14a126479221312d3368/pkg/apis/meta/v1/types.go#L41</a></li>
</ul>
<p>example of a pod declaration</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Pod</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span> <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>

    <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>

    <span style="color:#a6e22e">Spec</span> <span style="color:#a6e22e">PodSpec</span> <span style="color:#e6db74">`json:&#34;spec,omitempty&#34;`</span>

    <span style="color:#a6e22e">Status</span> <span style="color:#a6e22e">PodStatus</span> <span style="color:#e6db74">`json:&#34;status,omitempty&#34;`</span>
}
</code></pre></div><p>Note that the type and version are not set by the user, they are set when being marshaled in the versionserializer</p>
<h2 id="objectmeta"><code>ObjectMeta</code></h2>
<ul>
<li>corresponds to the <code>metadata</code> section in yaml</li>
<li>rarely read or written from in client-go code, but very key to the system</li>
</ul>
<h2 id="client-sets">Client Sets</h2>
<ul>
<li>gives access to multiple API groups and resources</li>
<li>also gives access to the discovery client</li>
</ul>
<h2 id="status-subresources">Status subresources</h2>
<ul>
<li>each deployment has a status subresource, updatestatus uses an additional http endpoint with <code>/status</code></li>
<li>used with <code>/apis/apps/v1beta1/namespaces/ns/deployments/name/status</code> can change the status of an object</li>
</ul>
<h2 id="listing-and-deletions">Listing and Deletions</h2>
<ul>
<li>ALlows to delete multiple objects of a namespace at once</li>
</ul>
<h2 id="watches">Watches</h2>
<ul>
<li>Gives an event interface for all changes, returns a channel
<ul>
<li>actually discouraged, should try to use <a href="/posts/informers_k8s/">informers (k8s)</a> instead</li>
</ul>
</li>
</ul>
<h2 id="client-options">Client Options</h2>
<ul>
<li>can set:
<ul>
<li>the version</li>
<li>wire format</li>
<li>user agent (allows for debugging and better log readability)</li>
</ul>
</li>
</ul>
<h2 id="informers--k8s----informers-k8s-dot-md--and-caching"><a href="/posts/informers_k8s/">informers (k8s)</a> and caching</h2>
<h2 id="work-queue">work queue</h2>
<ul>
<li>example: <a href="https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go">https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go</a></li>
<li>premade implementation of queue for building controllers</li>
</ul>
<h2 id="api-machinery--k8s----api-machinery-k8s-dot-md"><a href="/posts/api_machinery_k8s/">api machinery (k8s)</a></h2>
<h2 id="vendoring">vendoring</h2>
<ul>
<li>typical golang vendoring, or modules</li>
</ul>

          




   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   




      </div>
    </div>
  </div>
</div>

<script src="/js/URI.js" type="text/javascript"></script>

<script src="/js/page.js" type="text/javascript"></script>
</body>
</html>
