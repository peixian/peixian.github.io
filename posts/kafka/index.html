<!DOCTYPE html>
<html><title>kafka</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes" />


<link rel="stylesheet" href="/css/main.min.532078bb650bec3433e8e9db19e0453faa66c9cc0ce761054558a91d87039e9d.css"/>
<script defer src="/en.search.min.f4692ea4d64e41a43748db90f07e640b841e3e86be426a47f6885389450acf3a.js" integrity="sha256-9GkupNZOQaQ3SNuQ8H5kC4QePoa&#43;QmpH9ohTiUUKzzo="></script>

<link rel="stylesheet" href="/katex/katex.min.css" />
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
<body><header>
    <a href="/" id="logo">
        <img src="/svg/icon.svg" alt="icon" id="raccoon" />

    </a>
    <h3 class="site-title">عجفت الغور</h3>
    <div id="search">
        
<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>

    </div>
</header>

<div class="grid-container">
  <div class="grid">
    <div class="page" data-level="1">
      <div class="content">
          <h1>kafka</h1>

          <p>Tags: <a href="/posts/computers/">Computers</a></p>
<ul>
<li><a href="https://www.cloudkarafka.com/blog/2019-09-28-what-does-in-sync-in-apache-kafka-really-mean.html">https://www.cloudkarafka.com/blog/2019-09-28-what-does-in-sync-in-apache-kafka-really-mean.html</a></li>
</ul>
<h2 id="kafka-debugging">Kafka Debugging</h2>
<ul>
<li>CP kafka has tools installed under <code>/usr/local/bin</code></li>
<li>Example:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>/usr/bin/kafka-run-class kafka.tools.MirrorMaker --consumer.config source.config <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--producer.config dest.config <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--whitelist <span style="color:#e6db74">&#39;.*&#39;</span>
</span></span></code></pre></div></li>
<li>Can check consumer status with
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>/usr/bin/kafka-consumer-groups --bootstrap-server &lt;server:9092 --describe --group notification
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or</span>
</span></span><span style="display:flex;"><span>/usr/bin/kafka-consumer-groups --bootstrap-server &lt;server&gt;:9092 --list
</span></span></code></pre></div></li>
</ul>
<h2 id="smallrye--java-java-dot-md">SmallRye (<a href="/posts/java/">java</a>)</h2>
<ul>
<li>Framework that abstracts over multiple queues, allowing you to send to multiple kafkas
<ul>
<li><a href="https://smallrye.io/smallrye-reactive-messaging/latest/">https://smallrye.io/smallrye-reactive-messaging/latest/</a></li>
</ul>
</li>
</ul>
<h2 id="design">Design</h2>
<h3 id="producers">Producers</h3>
<figure><img src="/ox-hugo/2024-03-09_19-44-45_screenshot.png"/>
</figure>

<ul>
<li>Producer makes new messages</li>
<li>Components
<ul>
<li>Producer record: a record is kept for each message created, made of <code>&lt;topic&gt;, &lt;key/partition&gt;, &lt;value&gt;</code></li>
<li>Serializer: first thing a producer does to a message is to serialize the data into byte arrays</li>
<li>Partitioner: after serialization, it returns the parittions of a specific topic where the message should be assigned to. If there&rsquo;s a key, it uses a hash function on the message key (CRC32)
<ul>
<li>If it&rsquo;s a partition, it just assigns it to that partition</li>
</ul>
</li>
</ul>
</li>
<li>Default is one partition for each topic.</li>
<li>Producers already know which topic and partition the message should be written to, and sends it to the appropriate broker</li>
</ul>
<h3 id="broker">Broker</h3>
<figure><img src="/ox-hugo/2024-03-09_19-47-42_screenshot.png"/>
</figure>

<ul>
<li>Workers in kafka, which assign offsets to each message and stores them on disk</li>
<li>There&rsquo;s a cluster controller, elected via Paxos from <a href="/posts/paxos/#zookeeper">Zookeeper</a>, now <a href="/posts/raft/">raft</a>, which is responsbile for assigning partitions to brokers, elects partition leaders, and monitors broker failures</li>
<li>Since there&rsquo;s multiple brokers, it allows you to scale horizontally.</li>
<li>Tunable replication across different brokers</li>
</ul>
<h3 id="consumers">Consumers</h3>
<ul>
<li>Consumers organize themselves into consumer groups, which are keep the offset of the last ACKed message</li>
</ul>
<h3 id="efficiency">Efficiency</h3>
<h4 id="storage--storage-dot-md--layout-is-simple"><a href="/posts/storage/">storage</a> layout is simple</h4>
<figure><img src="/ox-hugo/2024-03-09_19-53-09_screenshot.png"/>
</figure>

<ul>
<li>a partition is &ldquo;just&rdquo; one big file, really a logical log that comprises a set of segement files approximately the same size.</li>
<li>new messages are appended to the end of the file, and there&rsquo;s some metadata that tracks the offsets each table has (similar to a sstable)</li>
<li>Similar to blocks on datastores, you can just delete old chunks of logs as they expire
<ul>
<li>every message has its id, but internally kafka addresses each message by it&rsquo;s logical offset</li>
</ul>
</li>
<li>when aconsumer sends a pull request to a broker, the broker keeps a data buffer ready for consumption. The broker then proceeds to read off of the different segements</li>
</ul>
<h4 id="efficient-transfer">Efficient transfer</h4>
<ul>
<li>
<p>Data flows in batches, producers can dispatch multiple requests and consumers can ack batches back</p>
</li>
<li>
<p>Aggressively caches the data in RAM via the filesystem</p>
</li>
<li>
<p>for subscriptions, kafka uses a <code>sendfile</code> syscall that bypasses the application/kernel buffers by copying directly from one fd to another</p>
<figure><img src="/ox-hugo/2024-03-09_19-53-00_screenshot.png"/>
    </figure>

</li>
</ul>
<h4 id="stateless-broker">Stateless broker</h4>
<ul>
<li>Consumption done by the consumer state is held in ZK, which helps in case of consumer failures.</li>
<li>Kafka&rsquo;s usage of time based SLA&rsquo;s (rentention time) is what allows the brokers to delete messages even when the consumer hasn&rsquo;t acked it</li>
<li>Consumers can also rewind, as it allows you to go back on offsets if there&rsquo;s errors</li>
</ul>
<h3 id="distributed-coordination">Distributed coordination</h3>
<ul>
<li>Partitions are the smallest unit of parallelism, and those need to be consumed by a single consumer</li>
<li>No specific manager nodes</li>
<li><a href="/posts/paxos/#zookeeper">Zookeeper</a> is responsible for keeping track of
<ul>
<li>addition or removal of consumers and brokers</li>
<li>registers consumers and brokers by creating emphemeral nodes</li>
<li>all the brokers try to create an emphemeral node called a controller, but only one succeeds. The first one is the leader</li>
<li>Rebalances processes in case brokers or consumers are added or removed</li>
<li>Maintain the consumption from brokers and track the offset of the last consumed messages of a partition</li>
</ul>
</li>
<li>ZK registries
<ul>
<li>Consumer registry - saves information in the consumer registry whenever it starts, has consumer group and subscribed topics</li>
<li>Broker registry - saves information in the broker registry, has the hostname, port, and set of partitions</li>
<li>Ownership registry - which consumer id is consuming from a specific partition</li>
<li>Offset registry - stores info related to each subscribed partition</li>
</ul>
</li>
<li>Rebalancing has to occur when a consumer or producer dies, but this means that message delivery has to stop
<ul>
<li>During rebalancing, different consumers have to take ownership of different partitions that are being read from. This means that they create ZK nodes to track them</li>
</ul>
</li>
</ul>
<h3 id="delivery-guarnetees">Delivery guarnetees</h3>
<ul>
<li>At-least-once delivery
<ul>
<li>default, delivers each message once to each consumer group.</li>
<li>Post rebalancing, just continue reading from the last offset</li>
</ul>
</li>
<li>Exactly once
<ul>
<li>We can use unique keys in the messages and write the results to a system that supports keys</li>
<li>Records and offsets can be saved somewhere else to dedup on the client end</li>
</ul>
</li>
<li>In-order delivery
<ul>
<li>Kafka guarnetees that messages in a partition are delivered in a specific order</li>
<li>No guarentees across multiple partitions</li>
</ul>
</li>
<li>Fault tolerance
<ul>
<li>Avoids log corruption with CRC checks on the created logs</li>
<li>Also replicates the partitions between different nodes
<ul>
<li>Replicas that do not lag are called in-sync replicas
<ul>
<li>considered to be replicas that have sent a heartbeat to ZK in the last 6 seconds (user configurable)</li>
<li>replicas that fetched messages from the leader in the last 10 seconds (user confiugurable)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="design-wisdom">Design Wisdom</h3>
<ul>
<li>Uses unconventional design, such as brokers not keeping state and not guarenteeing cross-partition ordering, but this pushes users to think more about parellism</li>
<li>Key thing is that brokers do not keep state, state is kept in ZK</li>
</ul>

          




   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   



  <div class="bl-section">
    <h4>Links to this note</h4>
    <div class="backlinks">
        <ul>
       
          <li><a href="/posts/big_data_processing/">big data processing</a></li>
       
          <li><a href="/posts/exactly_once_semantics_in_kafka/">exactly once semantics in kafka (atomic broadcast)</a></li>
       
          <li><a href="/posts/kafka_streams/">kafka streams</a></li>
       
     </ul>
    </div>
  </div>


      </div>
    </div>
  </div>
</div>

<script src="/js/URI.js" type="text/javascript"></script>

<script src="/js/page.js" type="text/javascript"></script>
</body>
</html>
