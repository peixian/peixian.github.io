<!DOCTYPE html>
<html><title>Databases</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes" />


<link rel="stylesheet" href="/css/main.min.532078bb650bec3433e8e9db19e0453faa66c9cc0ce761054558a91d87039e9d.css"/>
<script defer src="/en.search.min.8f05a91f8620f3a07254c7a0f43d203938d5166cb27f4cac5f31d6acd61f7168.js" integrity="sha256-jwWpH4Yg86ByVMeg9D0gOTjVFmyyf0ysXzHWrNYfcWg="></script>

<link rel="stylesheet" href="/katex/katex.min.css" />
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
<body><header>
    <a href="/" id="logo">
        <img src="/svg/icon.svg" alt="icon" id="raccoon" />

    </a>
    <h3 class="site-title">عجفت الغور</h3>
    <div id="search">
        
<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>

    </div>
</header>

<div class="grid-container">
  <div class="grid">
    <div class="page" data-level="1">
      <div class="content">
          <h1>Databases</h1>

          <p>Tags: <a href="/posts/computers/">Computers</a></p>
<h2 id="class">Class</h2>
<ul>
<li><a href="https://15721.courses.cs.cmu.edu/spring2019/schedule.html">https://15721.courses.cs.cmu.edu/spring2019/schedule.html</a></li>
<li><a href="https://www.youtube.com/playlist?app=desktop&amp;list=PLSE8ODhjZXjbohkNBWQs_otTrBTrjyohi&amp;themeRefresh=1">https://www.youtube.com/playlist?app=desktop&amp;list=PLSE8ODhjZXjbohkNBWQs_otTrBTrjyohi&amp;themeRefresh=1</a></li>
</ul>
<h2 id="mariadb">MariaDB</h2>
<ul>
<li><a href="https://mariadb.com/kb/en/index-hints-how-to-force-query-plans/">https://mariadb.com/kb/en/index-hints-how-to-force-query-plans/</a></li>
</ul>
<h2 id="calcite">Calcite</h2>
<ul>
<li><a href="https://calcite.apache.org">https://calcite.apache.org</a>
<ul>
<li>used in bodo.ai</li>
</ul>
</li>
</ul>
<h2 id="query-optimizers">Query optimizers</h2>
<ul>
<li>how good are query optimizers? <a href="https://www.vldb.org/pvldb/vol9/p204-leis.pdf">https://www.vldb.org/pvldb/vol9/p204-leis.pdf</a></li>
</ul>
<h2 id="query-pushdown">Query Pushdown</h2>
<ul>
<li>basically compliling the code and pushing the query down to the execution node</li>
<li><a href="https://blog.yugabyte.com/5-query-pushdowns-for-distributed-sql-and-how-they-differ-from-a-traditional-rdbms/">https://blog.yugabyte.com/5-query-pushdowns-for-distributed-sql-and-how-they-differ-from-a-traditional-rdbms/</a></li>
</ul>
<h2 id="foundation-db">Foundation DB</h2>
<ul>
<li><a href="https://apple.github.io/foundationdb/data-modeling.html">https://apple.github.io/foundationdb/data-modeling.html</a></li>
<li><a href="https://apple.github.io/foundationdb/developer-guide.html">https://apple.github.io/foundationdb/developer-guide.html</a></li>
</ul>
<h2 id="dynamodb">DynamoDB</h2>
<ul>
<li>
<p>Similar to <a href="/posts/20200415152613-cassandra/">Cassandra</a>, has partition key and sort key</p>
</li>
<li>
<p>Can horizontally partition across different nodes, similar to cassandra</p>
</li>
<li>
<p>Similarly, need to split a partition when it gets hot</p>
</li>
<li>
<p>There&rsquo;s an automated systems that defines a read capacity unit and a write capacity unit. If it exceeds, it splits</p>
</li>
<li>
<p>Note that since almost always you have hot partitions</p>
</li>
<li>
<p>Each node has multiple partitions</p>
<ul>
<li>Each partition has two buckets, an allocation bucket or a burst bucket</li>
<li>To handle a read, pick from any bucket</li>
<li>To handle a write, the node needs to check the token availability of buckets in the nodes of the entire replication group</li>
</ul>
</li>
<li>
<p>There&rsquo;s a global admission control system, where each request router calls to a global token bucket</p>
</li>
<li>
<p>No fixed schema</p>
<ul>
<li>composite key created from the partition key and the sort key <code>hash(partition key), sort key</code></li>
<li>has secondary indexes like <a href="/posts/20200415152613-cassandra/">Cassandra</a></li>
</ul>
</li>
<li>
<p>Similar to Cassandra</p>
</li>
<li>
<p>Automated adaption to traffic patterns, can move partitions around as needed</p>
</li>
<li>
<p>Uses <a href="/posts/multi_paxos/">multi-paxos</a> for consensus</p>
<ul>
<li>Leader election from multi-paxos</li>
<li>Write comes in to a laeder,</li>
<li>Leader prepares to send acceptors containing the WAL to acceptors</li>
<li>Acceptors acknolwledge the leader&rsquo;s WAL and returns</li>
<li>Leader will continue to renew lease as long as it is healthy</li>
</ul>
</li>
</ul>
<h3 id="partitioning">Partitioning</h3>
<ul>
<li>Hot partitions are possible</li>
<li>Alternatively, when a partition gets too big and needs to be pslit is <strong>throughput dilation</strong>.</li>
<li>Bursting a partition means using the unused capacity on co-resident partitions</li>
<li>Basically dynamo is organized into partitions, which contain collections of sstables. The hash value matches to a partition grouping, which are dynamic. Multiple partitions can be on the same machine, and bursts can be humored with</li>
<li>Meaning there&rsquo;s a problem of workload isolation on the co-resident partitions, we must find a way to maintain bursts (aka <a href="/posts/load_balancing/">load balancing</a>)
<ul>
<li>Token buckets!</li>
<li>When a node recieves a request, it checks for the available tokens in the allocation bucket.</li>
<li>If there&rsquo;s no space available, it checks the burst bucket</li>
<li>This allows it to smooth out traffic</li>
</ul>
</li>
<li>Scaling this out, we can create a global admission control
<ul>
<li>Central master</li>
<li>Tracks the consumption of a table using tokens</li>
<li>Request routers maintain local token buckets</li>
<li>Request routers communicate to the GAC for new tokens</li>
<li>All GAC servers are tracked by the GAC on an independent hash rings</li>
<li>Request routers manage tokens and keep deducting tokens as they accept requests</li>
<li>GAC estimates global token consumption using the information</li>
<li>GAC allocates tokens that are available</li>
</ul>
</li>
<li>Basically this is the equivilant of having a QPS measurer</li>
</ul>
<h3 id="replication">Replication</h3>
<ul>
<li>WAL&rsquo;s are used, but actually data replication is pretty slow</li>
<li>Solved with log replicas, just replicate the logs themselves (metadata operations) rather than the whole memtable</li>
<li>Silent data errors
<ul>
<li>Hardware failures can also cause incorrect data writes, so it uses checksums underneath (presumably they have their own filesystem)</li>
</ul>
</li>
</ul>
<h3 id="availability">Availability</h3>
<ul>
<li>
<p>Similar to <a href="#bigtable">BigTable</a>, replication groups are across different sets, and when a replication group is not healthy, the master replaces it</p>
</li>
<li>
<p>Master is done by leader election</p>
<figure><img src="/ox-hugo/2024-03-02_20-26-40_screenshot.png"/>
    </figure>

</li>
<li>
<p>However, sometimes grey failures happen where one node cannot reach the leader. Before it triggers an election, it asks if a quorum of other nodes can reach the leader</p>
<figure><img src="/ox-hugo/2024-03-02_20-30-11_screenshot.png"/>
    </figure>

</li>
</ul>
<h2 id="bigtable">BigTable</h2>
<ul>
<li>Key features
<ul>
<li>
<p>Single row transactions</p>
</li>
<li>
<p>No batching across row keys</p>
</li>
<li>
<p>Integer counters</p>
</li>
<li>
<p>MapReduce jobs as input source and output target</p>
<figure><img src="/ox-hugo/2024-02-21_16-32-56_screenshot.png"/>
        </figure>

</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>Uses a column family style, with groups of columns and a timestamp within each cell</li>
<li>Treats all data as raw byte strings</li>
<li>All rows have a row key (64kb string), each write and read is atomic</li>
<li>Column families allow for efficient read/write operations, since they usually hold data of the same type (data within a family is physically close)</li>
<li>Also has timestamps, keeps the latest 3 versions</li>
</ul>
<h3 id="components">Components</h3>
<h4 id="memtable">Memtable</h4>
<ul>
<li>Recent modifications in an in-memory, mutable sorted buffer</li>
<li>When a memtable grows big enough, its gets flushed to disk as an SSTable</li>
<li>Uses a write-ahead-log for this</li>
</ul>
<h4 id="sstable--sorted-string-table">SSTable (Sorted String Table)</h4>
<ul>
<li>Components
<ul>
<li>Data File</li>
<li>Primary Index</li>
<li>Bloom filter (for quickly checking if it&rsquo;s in the data structure)</li>
<li>Compression information</li>
<li>Stats</li>
<li>64kb blocks</li>
</ul>
</li>
<li>Immutable k/v mappings used to represent tablet states, consisting of blocks, with block indexes facilitating efficient disk access, and can be loaded into memory for quick queries</li>
</ul>
<h4 id="chubby">Chubby</h4>
<ul>
<li>Highly available and persistent distributed lock service</li>
<li>typically runs with five operating replicas, similar to zoo</li>
<li>Used in BigTable to ensure there&rsquo;s only one operational manager</li>
<li>Saves a bootstrap information as well as new tablet servers and failures</li>
<li>ACLs too</li>
</ul>
<h3 id="operations">Operations</h3>
<ul>
<li>Locating tablets for a piece of data
<ul>
<li>Uses a three level structure similar to a B+ tree</li>
<li>root tablet&rsquo;s location is stored in a Chubby file</li>
<li>second tier contains all metadata tablets</li>
<li>third tier contains all user tablets</li>
</ul>
</li>
<li>The root tablet is a pointer to other tablets</li>
<li>first tablet in the metadata data is the root tablet, which is treated differently</li>
<li>We cache tablet positions in the client library</li>
<li>Client can then check the metadata server, which then goes to chubby, to get info</li>
<li>Basically the thing to know is that this is similar to an inode, where there&rsquo;s three layers of indirection</li>
<li>A tablet is assigned to just one tablet server, the manager also maintains a record of unassigned tablets and allocates them to tablet servers that have enough space</li>
<li>Manager requires heartbeats and locks via chubby to assure that a tablet server is holding a tablet</li>
<li>New managers interact with each active tablet server after looking them up in the tablet server directory in chubby</li>
</ul>
<h4 id="writes">Writes</h4>
<ul>
<li>When a write is received by a tablet server, it gets checked to ensure to ensure data validity and proper formatting
<ul>
<li>check authorizations in the lock</li>
</ul>
</li>
</ul>
<h4 id="reads">Reads</h4>
<ul>
<li>Same thing as write, initial check is via authorization in chubby, and then loads the SS tables</li>
</ul>
<h3 id="minor-merging-and-major-compactions">Minor, Merging, and Major Compactions</h3>
<ul>
<li>Minor compaction is when it flushes the memtable to disk and turns it into an sstable</li>
<li>Merging compaction is when sstables become too many and we merge them together, although this could include deleted entries</li>
<li>Major compaction is when we merge multiple sstables together and remove the deleted datace the tombstones are handled</li>
</ul>
<h3 id="design-refinements">Design Refinements</h3>
<ul>
<li>Column family locality
<ul>
<li>compression is also done on the column family locality to store data</li>
</ul>
</li>
<li>Tablet caches in two ways
<ul>
<li>Scan cache - high level cache that stores k/v given to the tablet server</li>
<li>Block cache - caches blocks, like page caching</li>
</ul>
</li>
<li>Bloom filters
<ul>
<li>Bloom filters tell you 100% if it is <strong>not</strong> in the table.</li>
<li>Quickly check which things are in a sstable</li>
</ul>
</li>
<li>Commit logs
<ul>
<li>There&rsquo;s only one big commit log</li>
<li>Recovering servers must load off of another&rsquo;s commit log</li>
<li>Duplicate log reads are by sorting the entries by <code>&lt;table, row name, log seq number&gt;</code>.</li>
</ul>
</li>
<li>Speeding up tablet recovery
<ul>
<li>Most challenging and time consuming jobs is ensuring the tablet server gets all entries from the commit log</li>
<li>Minor compactions are done before moving to reduce the amount of stuff needed to move.</li>
</ul>
</li>
</ul>
<h3 id="system-design-wisdom">System Design Wisdom</h3>
<ul>
<li>Uses other services (Chubby and GFS) as building blocks</li>
<li>Locality hints from the users for many of its optimizations, such as column families</li>
<li>One log file per tablet is a way to allow individual tablets to recover</li>
<li>Single manager interface</li>
</ul>
<h2 id="megastore">Megastore</h2>
<ul>
<li>SQL based system</li>
<li>Built on top of bigtable</li>
<li>Main goal was to facilitate ACID transactions</li>
</ul>
<h3 id="design">Design</h3>
<ul>
<li>Application server
<ul>
<li>Used to deploy megastore, local replica on each application server, which writes to the local bigtable</li>
</ul>
</li>
<li>Megastore library
<ul>
<li>Connects and implements paxos and replica picking</li>
</ul>
</li>
<li>Replication server
<ul>
<li>Checks for unfinished writes, similar to a garbage collector, which provides paxos no-op commands</li>
</ul>
</li>
<li>Coordinator
<ul>
<li>Keeps track of entity groups which its replicas has seen every Paxos write</li>
</ul>
</li>
<li>Bigtable
<ul>
<li>Handles arbitrary reads and write throughputs</li>
</ul>
</li>
</ul>
<figure><img src="/ox-hugo/2024-02-22_19-02-48_screenshot.png"/>
</figure>

<h3 id="replication-strats">Replication Strats</h3>
<ul>
<li>Async primary/secondary - write ahead logs are replciated to at least one secondary node, but log appends are recognized and serialized at the primary node while being sent down to the secondary nodes. Primary is responsible for ACID, but it is acceptable to have a node fail and a secondary take on a primary.</li>
<li>Sync primary/secondary, primary node waits until its actually been replicated before doing a tx</li>
<li>Optimistic replication, where no primary, and any node can accept the changes and propagate them async to other nodes. Better availability and latency, but transactions are not possible.</li>
</ul>
<h3 id="paxos">Paxos</h3>
<ul>
<li>Megastore implements paxos, which has issues being slow</li>
<li>But Paxos gives
<ul>
<li>NO primary but a group</li>
<li>WAL is replciated to all nodes</li>
<li>Any node can start read/write</li>
<li>Every log adds the changes only if a majority acks</li>
<li>Remaining nodes eventually catch up</li>
<li>Communication is hindered if a majority is down</li>
</ul>
</li>
<li>Entity groups are used to replicate</li>
</ul>
<figure><img src="/ox-hugo/2024-02-22_19-06-43_screenshot.png"/>
</figure>

<ul>
<li>In entity groups, entities are changed using single-phase ACID transactions, which paxos uses to replicate the common record
<ul>
<li>2pc can also be used</li>
</ul>
</li>
<li>Megastore async replicates between different entity groups. Local indexes have strong consistenty, but global ones have weak consistenty</li>
</ul>
<figure><img src="/ox-hugo/2024-02-22_19-14-17_screenshot.png"/>
</figure>

<h3 id="megastore-data-model">Megastore Data Model</h3>
<ul>
<li>API design
<ul>
<li>Relatively stable performance benefits</li>
<li>Shift work from read time to write time since there&rsquo;s definitely going to be more reads than writes</li>
</ul>
</li>
<li>Data model is strongly typed, similar to RDMS, where schemas and a collection of tables are named and typed.</li>
<li>Key distinctions: root tables and child tables
<ul>
<li>Child table needs to specificy a foreign key referring to a root table, and a root table and all its child tables make up an entity group</li>
</ul>
</li>
<li>Prejoining with keys
<ul>
<li>normally, primary keys have surrogate values that idenitfy each row in a table</li>
</ul>
</li>
<li>Two layers of secondary indexes
<ul>
<li>Local index: each group&rsquo;s local index is used as a distinct index, which locates data inside an entity group</li>
<li>Global index: encompasses many entity groups, used to locate entities without knowing which entity groups include them in advance</li>
</ul>
</li>
<li>All of this is splayed on top of big table to get atomicity, consistency, isolation, and durability
<ul>
<li>Uses the versioning feature of bigtable to implement multi-version concurrency control</li>
</ul>
</li>
<li>Read consistency
<ul>
<li>Gives you three levels
<ul>
<li>Current: makes sure all committed writes have been executed, and does a read</li>
<li>Snapshot: reads the latest committed write operation</li>
<li>Inconsistent: reads the most recent value without considering the log&rsquo;s state</li>
</ul>
</li>
</ul>
</li>
<li>Writes
<ul>
<li>Writes do a current read before doing a write so it can find the latest offset for the log, then uses paxos to get all nodes to buy in, then commits it and updates it in bigtable</li>
</ul>
</li>
<li>Queues
<ul>
<li>Transactional messaging among groups of entities are handled through queues, which is used for batching many changes into a single transaction</li>
</ul>
</li>
</ul>
<h3 id="replication-in-megastore">Replication in Megastore</h3>
<ul>
<li>Paxos WAL is mostly where it sits</li>
<li>Also allows local reads from anywhere, since paxos is used to make sure everyone is together</li>
<li>Each log position is a paxos usage, which optimizes to skip the preparation phase and enter the acceptance phase when the same proposer makes continous proposals</li>
<li>Leader decides which values are allowed ot use proposal 0</li>
<li>Different types of replicas
<ul>
<li>Witness replicas
<ul>
<li>Have WALs and vote in Paxos</li>
<li>Reduced storage costs because they don&rsquo;t actually store the data</li>
<li>Are able to avoid the need for an additional round trip when unable write</li>
</ul>
</li>
<li>Read only replicas
<ul>
<li>Can&rsquo;t vote</li>
<li>Contain snapshots of the data</li>
<li>Read only replicas can distribute the data over large geographic area, basically a CDN</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="replicated-logs">Replicated Logs</h4>
<ul>
<li>Replicated logs have many shapes, but we also allow holes in the logs for when consensus was not found</li>
<li>Catching up
<ul>
<li>Node checks if the entity group is up-to-date locally by contacting the coordinator of the local replica</li>
<li>Then finds the position, which detemrines and picks a replica that has applied through the highest possibly commited log position</li>
<li>Catches up by reading the values from the different replicas. Empty no-op values for ones that are disputed, Paxos then forces all the majority of the replicas to accept the no-op or previously comimtted write</li>
</ul>
</li>
<li>Coordinators oversee the entire process, and they themselves are locked in Chubby</li>
</ul>
<h2 id="scaling-memcache">Scaling Memcache</h2>
<ul>
<li><code>set</code>, <code>get</code>, <code>delete</code> operations</li>
</ul>
<h3 id="main-data-structures-of-memcache">Main data structures of memcache</h3>
<ul>
<li>
<p>Hash table</p>
<ul>
<li>Chained hash table, everything is a linked list</li>
</ul>
</li>
<li>
<p>Cache item data structure</p>
</li>
<li>
<p>Slab allocator</p>
<ul>
<li>Memcached Items
<ul>
<li>Item that holds data for a k,v pair</li>
</ul>
</li>
<li><a href="/posts/allocators/">allocators</a></li>
<li>A slab is a list of memory sections containing objects (pages) categories by the memroize size range they fall into
<ul>
<li>By default the memory is split into 42 slabs</li>
<li>first slab for items less than 96 bytes</li>
<li>second for 96-120 bytes</li>
<li>etc</li>
</ul>
</li>
</ul>
</li>
<li>
<p>LRU list</p>
<ul>
<li>For evicting the oldest and least used items, LRU matches to different slabs</li>
</ul>
</li>
</ul>
<h3 id="memcache-design">Memcache Design</h3>
<ul>
<li>Adaptive slab allocator
<ul>
<li>Peroidic rebalancing of slabs</li>
<li>If slabs needs more memory if it is evicting a lot of items, or if an item that is evicted was being used 20% more recently than the average of the least recently used item in other slab classes</li>
<li>When we identify a needy slab, we free up the least recently used slab and transer it to the needy class</li>
</ul>
</li>
<li>Short lived keys are pruned using a circular buffer than removes one item every second</li>
</ul>
<h3 id="memcache-clustering">Memcache Clustering</h3>
<ul>
<li>Key load is managed by consistent hashing</li>
<li>although this means we need a memcached router for balancing, hence <a href="https://github.com/facebook/mcrouter">https://github.com/facebook/mcrouter</a></li>
<li>MC router talks with the memcache ASCII protocol</li>
<li>Network efficiency issue: incast congestion
<ul>
<li>When a large number of responses to request overload a DC&rsquo;s cluster and rack switches, when we to rack to rack, such as broadcasting with memcache</li>
<li>Use a sliding window, similar to TCP</li>
</ul>
</li>
<li>High load issues
<ul>
<li>Stale sets
<ul>
<li>When a sequence of concurrent operations get reordered</li>
</ul>
</li>
<li>Thundering herd
<ul>
<li>When multiple clients attempt to request the same thing at once</li>
</ul>
</li>
<li>Solution: use leases
<ul>
<li>We &ldquo;lease&rdquo; the key value to a client by allocating a token, to set the item, the client has to provide the token again</li>
<li>A token can be invalidated if the Memcached server receives a delete request for the key
<ul>
<li>Similar to load-linked and store-conditionals</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Different applications need different sizes, what do we do?
<ul>
<li>Different pools of memcached, such as low-churn keys and high-churn keys</li>
<li>Replication within pools to improve latency and divide the load
<ul>
<li>Sometimes we want to split the keyset, but other times we might just want to replicate the key set</li>
</ul>
</li>
</ul>
</li>
<li>Small outages
<ul>
<li>Add &ldquo;gutter&rdquo; servers, which do not rehash the key-value items to other Memcached using consistent hashing. K/V&rsquo;s in the gutter pool are drained quickly</li>
</ul>
</li>
</ul>
<h3 id="regional-level-memcache">Regional Level Memcache</h3>
<ul>
<li>Scaling a cluster natively makes it so that our networks start to face incast congestion</li>
<li>We&rsquo;d rather replicate clusters</li>
<li>But how do we invalidate when we replicate?</li>
<li>THere needs to be two ways of invalidation: either the backend DB invalidates the key on an update, or the client does
<ul>
<li>We can set an invalidation daemon that discovers or just broadcasts UDP to all memcached instances to invalidate</li>
<li>Note that the dameons batch as well</li>
</ul>
</li>
</ul>
<h3 id="controlling-replication-in-regional-pools">Controlling replication in regional pools</h3>
<ul>
<li>How many places should keys be replicated?</li>
<li>Create a regional pool of memcached servers that multiple clients share, and move data between different pools as needed</li>
</ul>
<h3 id="bringing-up-new-pools">Bringing up new pools</h3>
<ul>
<li>New pools should look at warm pools to replicate, not the DB, otherwise it threatens to overwhelm the DB</li>
<li>To avoid races, we hold off <code>delete</code> operations, and clients add to the new cluster instead of the old</li>
</ul>
<h3 id="cross-regional-memcached">Cross Regional Memcached</h3>
<ul>
<li>Cross region replication is a huge pain</li>
<li>100-300 ms</li>
<li>How do we deal with writes from a secondary region?
<ul>
<li>User writes to one region, and reads from another</li>
<li>Set a remote marker in the local region for a specific key</li>
<li>Perform writes that are appended with the key and the remote marker</li>
<li>Delete the key in the local cluster</li>
<li>Eventual consistency considered acceptable in this case</li>
</ul>
</li>
</ul>
<h2 id="spanner">Spanner</h2>
<ul>
<li><a href="https://www.cs.princeton.edu/courses/archive/fall16/cos418/docs/P6-Spanner.pdf">https://www.cs.princeton.edu/courses/archive/fall16/cos418/docs/P6-Spanner.pdf</a></li>
<li>Worldwide LTP, SQL semantics, horizontal scalability, availablity, transactional consistency</li>
<li>Parts
<ul>
<li>Client</li>
<li>Load balancer</li>
<li>Zone - between 100 and a few thousand servers
<ul>
<li>Zone manager</li>
<li>Placement driver, responsible for automated data transfer between zones</li>
</ul>
</li>
<li>Location proxy
<ul>
<li>Uses the per zone location proxies to find spanservers for data</li>
</ul>
</li>
<li>Universe manager
<ul>
<li>For interactive debugging</li>
</ul>
</li>
<li>Spanserver - consists of tablets</li>
<li>Colossus - distributed file system that stores tablet&rsquo;s state similar to B-tree format</li>
</ul>
</li>
</ul>
<h3 id="design">Design</h3>
<ul>
<li>Spanner is deployed as &ldquo;universes&rdquo;, and only a few are active at one time</li>
<li>Each one relies on TrueTime to provide strong external consistency and global serialization</li>
<li>Also performs automatic resharding based on data size and load</li>
<li>Universe manager and placement driver are both singletons, although there are shadow replicas that will take over</li>
<li>Each zone works like a cluster of bigtable servers, each spanserver has several tablets ranging from 100-1000
<ul>
<li>(key:string, timestamp:int64) -&gt; strings</li>
</ul>
</li>
<li><a href="/posts/paxos/">paxos</a> and TrueTime are used to cover time, and Colossus is used to store data</li>
<li>Each tablet stores metadata and logs for the state machines, and the paxos implementation supports time-based leaders with long-lived leaders (aka fastpaxos)
<ul>
<li>Single leader fast paxos effectively function as raft</li>
</ul>
</li>
<li>Concurrency is handled via a lock table
<ul>
<li>Each server enforces concurrency control based on the long-lived paxos leader</li>
<li>Paxos leaders have around 10s for their leases</li>
</ul>
</li>
<li>Paxos group that has a participant leader that acts as the transaction manager, and the other replicas are participant followers.</li>
<li>For transactions that span multiple groups, a coordinator is elected</li>
<li>Note that we only lock for writes</li>
<li><a href="/posts/bully_algorithm/">bully algorithm</a> is used for leader election</li>
</ul>
<h4 id="writes-and-reads">Writes and Reads</h4>
<ul>
<li>When a write is done, the lease vote is automatically extended, and leaders need to ask for a lease extension.</li>
<li>Notably, it waits out the uncertainty before proceeding with a commit</li>
<li>To serve reads, each replica in Spanner keeps track of the maximum timestap that it was up to date. When a read transaction comes in, it decides whether it&rsquo;s able to serve it</li>
<li>Commit protocol guaranteees that all nodes know the lower bound of a prepared transaction timestamp.</li>
<li>We have to assign a timestamp for a snapshot reads, and snapshot reads are only done on replicas that are up to date</li>
</ul>
<h3 id="database-buckets">Database Buckets</h3>
<ul>
<li>Spanner has an additional layer of abstraction over the bag of key-value mappings in the form of a directory or bucket
<ul>
<li>All adjacent keys that begin with the same prefix</li>
<li>All the data in the same bucket shares the same replication settings</li>
<li>Move frequently accessed buckets into the same paxos group or place a bucket geographically closer to its accessors</li>
</ul>
</li>
<li>Spanner buckets differ from Bigtable ones because they don&rsquo;t need to be lexicographically contiguous</li>
<li>We can <code>movedir</code> buckets across Paxos groups, which then moves the data in the background. The metadata setting is then flipped in the background RCU style</li>
<li>We use a bucket to specify the geographical replication attributes and placements
<ul>
<li>Two settings:
<ul>
<li>Total number and type of replicas
<ul>
<li>You can tune the amount of voting replicas and place them physically closer</li>
<li>Read only - can&rsquo;t vote, only allow for scaling reads</li>
<li>Witness - Vote for the leader and commit write transactions, but don&rsquo;t keep a copy of the data. Can&rsquo;t serve as read leaders</li>
<li>Read-write replicas - Does both, can be a leader</li>
</ul>
</li>
<li>Geographic placement of replicas</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="data-model">Data Model</h3>
<ul>
<li>SQL-like, but Megastore had poor performance</li>
</ul>
<h3 id="truetime--dot-dot-dot-dot-dropbox-org-truetime-dot-md"><a href="/posts/truetime/">truetime</a></h3>
<ul>
<li>With truetime, any two transactions T1 and T2,m if T2 begins to commit after T1 completes committing, then T2&rsquo;s timestamp is &gt; T1&rsquo;s timestamp</li>
<li>Consistent timestamp allows easy snapshot isolation, since we can just read at a point in tiem</li>
</ul>
<h3 id="cap-theorem-and-spanner">CAP theorem and spanner</h3>
<ul>
<li>does not guarentee uptime, but real databases need maint anyways, so it is &ldquo;essentially CA&rdquo;</li>
<li>Since paxos is used, it opts for consistency over availability, as paxos is possible to livelock</li>
</ul>
<h3 id="db-transactions">DB Transactions</h3>
<h4 id="read-transactions">Read Transactions</h4>
<ul>
<li>For read transactions, we buffer them on the client side until commits.</li>
<li>Transactions writes are not visible to subsequent reads inside the same transaction</li>
<li>Uses wound-wait to prevent deadlocks
<ul>
<li>Read request</li>
<li>The lead replica acquires a lock</li>
<li>Read to update to date data from the replicas</li>
</ul>
</li>
<li>For read-only transactions
<ul>
<li>within a single paxos groups: just send the read transaction to the group&rsquo;s leader</li>
<li>if it&rsquo;s multiple paxos groups: then determine the \(s_{read}\) value on the last timestamp by doing consensus with leaders
<ul>
<li>Or avoid the consensus round</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="uses-a-2pc">Uses a 2PC</h4>
<ul>
<li>Guarentees isolation and strong consistency</li>
<li>If participants in a 2PC are physically nearby, then it selects paxos groups closer</li>
<li>Leader who aren&rsquo;t coordinators gets access to write locks, and then also does prepare timestamps</li>
<li>Coordinator roles
<ul>
<li>The coordinator bypasses the prepare step and gets locks for writes, and recieves inputs from all the group&rsquo;s leaders</li>
<li>Commit transactions
<ul>
<li>Greater than or equal all prepare timestamps to satisfy the invariants of read-write transactions</li>
<li>Greater than TT.now().latest</li>
<li>Greater than the timestamps of all the transactions that the leader coordinator has assigned previously</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure><img src="/ox-hugo/2024-02-27_20-44-32_screenshot.png"/>
</figure>

<h4 id="schema-change-transactions">Schema Change Transactions</h4>
<ul>
<li>Changing the schema in Spanner
<ol>
<li>A future timestamp is determined in the prepare phase</li>
<li>Consider that the t is the timestamp of a registered schema change transaction</li>
</ol>
</li>
</ul>
<h3 id="eval">Eval</h3>
<ul>
<li>Important thing to understand about spanner is TrueTime, by putting bounds on clock drift, you acn get transactions</li>
</ul>

          




   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   



  <div class="bl-section">
    <h4>Links to this note</h4>
    <div class="backlinks">
        <ul>
       
          <li><a href="/posts/20200415152613-cassandra/">Cassandra</a></li>
       
          <li><a href="/posts/dataflow/">dataflow</a></li>
       
          <li><a href="/posts/dbsp_automatic_incremental_view_maintenance_for_rich_query_languages/">DBSP: Automatic Incremental View Maintenance for Rich Query Languages</a></li>
       
          <li><a href="/posts/distributed_systems/">distributed systems</a></li>
       
          <li><a href="/posts/elixir/">elixir</a></li>
       
          <li><a href="/posts/k_v_stores/">k/v stores</a></li>
       
          <li><a href="/posts/paxos/">paxos</a></li>
       
          <li><a href="/posts/philips_introducing_operators/">philips: introducing operators</a></li>
       
          <li><a href="/posts/20200415211012-postgres/">postgres</a></li>
       
          <li><a href="/posts/truetime/">truetime</a></li>
       
     </ul>
    </div>
  </div>


      </div>
    </div>
  </div>
</div>

<script src="/js/URI.js" type="text/javascript"></script>

<script src="/js/page.js" type="text/javascript"></script>
</body>
</html>
