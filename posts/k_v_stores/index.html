<!DOCTYPE html>
<html><head>
<title>k/v stores</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://rsms.me" crossorigin>


<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400;1,700&family=JetBrains+Mono&display=swap">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">



<link rel="stylesheet" href="/css/main.min.7a8dc5b063775e5d3df0beea151395736f55ccb3343f70eea0595b53da5015c4.css">


<script defer src="/en.search.min.c61d7710b45309b00c08dc75b18e3c1756d826642937afd09eeb3b9ae90e4183.js" integrity="sha256-xh13ELRTCbAMCNx1sY48F1bYJmQpN6/Qnus7mukOQYM="></script>


<link rel="stylesheet" href="/katex/katex.min.css" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="/katex/katex.min.css"></noscript>
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
</head>
<body><header>
    <div class="header-main">
        <a href="/" id="logo">
            <img src="/svg/icon.svg" alt="icon" id="raccoon" />
        </a>
        <h3 class="site-title">عجفت الغور</h3>
        <div id="search">
            
<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>

        </div>
    </div>
    <nav id="breadcrumb" aria-label="Note trail"><span class="trail-label">trail</span><span class="trail-crumbs"></span></nav>
</header>

<div class="layout-container">
  <div class="grid-container">
    <div class="grid">
      <div class="page" data-level="1">
        <div class="content">
            <h1>k/v stores</h1>
            


            <p>Tags: <a href="/posts/databases/">Databases</a></p>
<h2 id="rocksdb">RocksDB</h2>
<ul>
<li>Dong, Siying, Andrew Kryczka, Yanqin Jin, and Michael Stumm. “RocksDB: Evolution of Development Priorities in a Key-Value Store Serving Large-Scale Applications.” ACM Transactions on Storage 17, no. 4 (2021): 1–32. <a href="https://doi.org/10.1145/3483840">https://doi.org/10.1145/3483840</a>.</li>
</ul>
<h3 id="myrocks">MyRocks</h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=Lxbb_7q8iRo">https://www.youtube.com/watch?v=Lxbb_7q8iRo</a></li>
<li>Better SSD efficiency</li>
<li>Better space efficiency</li>
<li>&ldquo;if you fit the entire working set in ram, you have too much ram?&rdquo;
<ul>
<li>If all working set is in RAM, then you&rsquo;re not being efficient with your ram</li>
<li>What if we are writing back pages with one bit change? Terrible write amplification, only rows in LSM trees</li>
<li>Are you trying to read keys that don&rsquo;t exist? B-trees have this issue</li>
</ul>
</li>
<li>LSM tree is more space efficient than b-trees
<ul>
<li>wasting 1/3rd to 1/2 of the pool, but 10% with LSM tree. How?</li>
</ul>
</li>
<li>Better write efficiency is that you use less space so less write efficiency</li>
<li>Secondary indices?</li>
<li>RocksDB is very hard to tune
<ul>
<li><code>rocksdb_block_cache_size</code></li>
<li><code>rocksdb_max_background_compactions</code></li>
</ul>
</li>
<li>Uncommitted changes are buffered in memory by myrocks for tx&rsquo;s</li>
<li>Performance</li>
</ul>
<figure><img src="/ox-hugo/2025-12-07_16-14-47_screenshot.png"/>
</figure>

<h2 id="speeddb-https-github-dot-com-speedb-io-speedb">SpeedDB - <a href="https://github.com/speedb-io/speedb">https://github.com/speedb-io/speedb</a></h2>
<h2 id="zippydb">ZippyDB</h2>
<figure><img src="/ox-hugo/2024-02-10_17-50-47_screenshot.png"/>
</figure>

<ul>
<li>Build on RocksDB, but less management</li>
<li>Generic KV store, supports snapshot reads and partial read/write</li>
<li>Snapshot reads
<ul>
<li>cheap operation that uses snapshot handlers to perform multiple reads</li>
<li>basically RCU, but if you read while a write is happening the read goes to a snapshot
<ul>
<li>handles versions, whereas RCU doesn&rsquo;t handle versions</li>
<li>also uses a cleaner or garbage collector or sweeper, whereas RCU places the burden on the writer</li>
</ul>
</li>
</ul>
</li>
<li>Data can be replicated either with <a href="/posts/gossip_protocols/">gossip protocols</a> or <a href="/posts/paxos/">paxos</a>, although usually there&rsquo;s a master
<ul>
<li>specific read only replicas called followers are occasionally added for high volume reads</li>
</ul>
</li>
<li>Divides times into small epocs, each epoc zippy assigns a primary replica, that is the paxos leader
<ul>
<li>Allows clients to choose which consistency level they come into (same as Spanner)</li>
<li>Consistent reading -&gt; clients go to the current primary of the shard</li>
<li>Stale information -&gt; can go to a replica</li>
<li>Also allows for read-your-writes with a hash that signals to the replicas to manually update</li>
</ul>
</li>
<li>Has a data shuttle, which basically tiers it into Primary -&gt; Secondary -&gt; Follower, on per shard basis
<ul>
<li>A shard is a box</li>
</ul>
</li>
<li>Shard management service is the orchestrator, and tells each shard what they own, master that runs over the control plane</li>
<li>Store is based on top of <a href="#rocksdb">RocksDB</a></li>
</ul>
<h2 id="silt-design-from-cassandra--20200415152613-cassandra-dot-md--dynamo">SILT Design -&gt; From <a href="/posts/20200415152613-cassandra/">Cassandra</a>/dynamo</h2>
<ul>
<li>Scalable Index Large Table, that internally uses multiple stores</li>
<li>\(read amplification = {data read from storage}/{data read by application}\)</li>
<li>\(write amplification = {data written to storage}/{data written by application}\)</li>
</ul>
<h3 id="note-which-things-we-can-put-in-ram-vs-storage">Note which things we can put in RAM vs Storage</h3>
<ul>
<li>RAM: index and filter, filters, index
<ul>
<li><code>PUT</code> and <code>DELETE</code> are both managed here</li>
</ul>
</li>
<li>Storage: log, hash tables, sorted things</li>
</ul>
<h3 id="looking-up-logs-via-in-memory-hash-table">Looking up logs via In Memory Hash Table</h3>
<ul>
<li>Write friendly store will append all <code>PUT</code> and <code>DELETE</code> into an in-storage log which makes the writing process fast, incoming requests are recorded as a write ahead log</li>
<li>Keep an in memory hash table that maps keys to their offset in the log, each entry in the hash table is added right after a successful entry in the in-storage log</li>
<li>Use a partial-key cuckoo hashing
<ul>
<li>Use part of the key, cuckoo hashing requires two ahsh functions, each of which map to two candidate buckets in the hash table.</li>
<li>Inserting/deleting a key:
<ol>
<li>compute buckets <code>h1(K1)</code> and <code>h2(K1)</code>, and check if one or both or none of the two buckets are empty</li>
<li>If at least one bucket is empty, insert it into the bucket</li>
<li>If both buckets are occupied, move or create a new table</li>
</ol>
</li>
<li>Doing a get:
<ol>
<li>if we do a get, look it up in the hash table. If there&rsquo;s nothing in the hash table, go to the intermediary stores</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="intemediary-stores">Intemediary Stores</h3>
<ul>
<li>
<p>When the write-friendly store is full, it needs to create a new instance for further insertions</p>
</li>
<li>
<p>Basically compacts the log into a smaller log, sorted by hash</p>
<figure><img src="/ox-hugo/2024-02-11_18-58-11_screenshot.png"/>
    </figure>

</li>
</ul>
<figure><img src="/ox-hugo/2024-02-11_18-58-20_screenshot.png"/>
</figure>

<ul>
<li>Similar to before, GETS can just use the hash table except it&rsquo;s compacted for retrivals</li>
</ul>
<h3 id="memory-efficient-store">Memory Efficient Store</h3>
<ul>
<li>
<p>At the final level, we need to compact more. These will sort keys and merge them using a trie</p>
<figure><img src="/ox-hugo/2024-02-11_19-00-41_screenshot.png"/>
    </figure>

</li>
</ul>

            




   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   



  <div class="bl-section">
    <h4>Links to this note</h4>
    <div class="backlinks">
        <ul>
       
          <li><a href="/posts/etcd/">etcd</a></li>
       
          <li><a href="/posts/storage/">storage</a></li>
       
     </ul>
    </div>
  </div>


        </div>
      </div>
    </div>
  </div>
  

<nav id="toc" class="toc-sidebar">
  <div class="toc-content">
    <h2>Table of Contents</h2>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#rocksdb">RocksDB</a>
      <ul>
        <li><a href="#myrocks">MyRocks</a></li>
      </ul>
    </li>
    <li><a href="#speeddb-https-github-dot-com-speedb-io-speedb">SpeedDB - <a href="https://github.com/speedb-io/speedb">https://github.com/speedb-io/speedb</a></a></li>
    <li><a href="#zippydb">ZippyDB</a></li>
    <li><a href="#silt-design-from-cassandra--20200415152613-cassandra-dot-md--dynamo">SILT Design -&gt; From <a href="HAHAHUGOSHORTCODE931s5HBHB">Cassandra</a>/dynamo</a>
      <ul>
        <li><a href="#note-which-things-we-can-put-in-ram-vs-storage">Note which things we can put in RAM vs Storage</a></li>
        <li><a href="#looking-up-logs-via-in-memory-hash-table">Looking up logs via In Memory Hash Table</a></li>
        <li><a href="#intemediary-stores">Intemediary Stores</a></li>
        <li><a href="#memory-efficient-store">Memory Efficient Store</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</nav>


</div>

<script src="/js/URI.js" type="text/javascript"></script>

<script src="/js/page.js" type="text/javascript"></script>
</body>
</html>
